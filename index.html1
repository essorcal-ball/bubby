<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventures of Bob the Stickman</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10b981', // green-500
                        'secondary': '#3b82f6', // blue-500
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the keyboard key */
        kbd {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 4px;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: nowrap;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px #fff inset;
            background-color: #f7f7f7;
            color: #333;
        }
        .game-simulation {
            animation: run 4s linear infinite;
        }
        /* Keyframe animation to simulate the background scrolling/running */
        @keyframes run {
            0% { background-position: 0 0; }
            100% { background-position: -400px 0; }
        }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4 bg-gray-100">

    <!-- Background Decoration -->
    <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-blue-100 opacity-80 -z-10"></div>

    <!-- Main App Container -->
    <div id="app" class="relative w-full max-w-4xl flex items-center justify-center">
        <!-- Content will be rendered here -->
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP ---

        // Firebase Configuration (provided by environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'adventures-of-bob';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Game Constants
        const UPGRADES = [
            { key: 'disappearObstacle', name: 'Disappear Obstacle', cost: 50, description: 'Clears obstacles in a small area when activated.', icon: 'üí•' },
            { key: 'invisible', name: 'Invisible Skin', cost: 100, description: 'Makes Bob invincible and lightly shaded for a short time.', icon: 'üëª' },
        ];
        const COIN_VALUE = 10;
        const POWER_UP_DURATION_MS = 5000;
        
        // Firebase Instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // State Variables
        let coins = 0;
        let ownedUpgrades = {};
        let activePowerUp = null; // 'disappearObstacle', 'invisible', or null
        let notification = '';
        let currentView = 'menu';
        let isCoinAvailable = true; // State for the coin simulation in the game

        const appElement = document.getElementById('app');

        // --- UTILITY FUNCTIONS ---

        /** Updates the state variables and re-renders the UI. */
        function updateState(newState) {
            Object.assign(window.gameData, newState);
            renderApp();
        }

        /** Shows a temporary notification message. */
        function showNotification(message, duration = 2000) {
            updateState({ notification: message });
            setTimeout(() => updateState({ notification: '' }), duration);
        }

        /** Renders a common button style. */
        function NavButton(text, onClick, color = 'primary') {
            return `
                <button onclick="${onClick}"
                    class="w-full sm:w-64 px-8 py-4 m-2 text-xl font-bold rounded-xl shadow-lg
                           transform transition duration-300 ease-in-out
                           bg-${color}-500 hover:bg-${color}-600 text-white
                           hover:scale-105 active:scale-95 ring-4 ring-${color}-300">
                    ${text}
                </button>
            `;
        }

        // --- CORE GAME LOGIC (FIREBASE INTERACTION) ---

        /** Initializes the user data in Firestore if it doesn't exist. */
        async function setupUserData(docRef) {
            const initialData = {
                coins: 100,
                upgrades: { disappearObstacle: false, invisible: false },
                activeSkin: 'default',
            };
            try {
                await setDoc(docRef, initialData, { merge: true });
            } catch (e) {
                console.error("Error setting initial document:", e);
            }
        }

        /** Handles purchasing an upgrade using a Firestore transaction. */
        async function buyUpgrade(upgradeKey, cost) {
            if (!db || !userId || !isAuthReady) return;

            const userProfilePath = `/artifacts/${appId}/users/${userId}/gameData/profile`;
            const docRef = doc(db, userProfilePath);
            const upgradeName = UPGRADES.find(u => u.key === upgradeKey)?.name || 'Item';

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);

                    if (!docSnapshot.exists()) throw new Error("User profile not found.");

                    const data = docSnapshot.data();
                    const currentCoins = data.coins || 0;
                    const currentUpgrades = data.upgrades || {};

                    if (currentUpgrades[upgradeKey]) throw new Error(`You already own the ${upgradeName} upgrade!`);
                    if (currentCoins < cost) throw new Error("Not enough coins!");

                    transaction.update(docRef, {
                        coins: currentCoins - cost,
                        [`upgrades.${upgradeKey}`]: true,
                    });

                    showNotification(`${upgradeName} purchased!`);
                });
            } catch (e) {
                showNotification(e.message || "Purchase failed.", 3000);
                console.error("Transaction failed:", e);
            }
        }

        /** Handles collecting coins in the game simulation. */
        async function collectCoin() {
            if (!db || !userId) return;
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/gameData/profile`);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    const currentCoins = docSnapshot.data()?.coins || 0;
                    transaction.update(docRef, { coins: currentCoins + COIN_VALUE });
                    showNotification(`Collected ${COIN_VALUE} Coins! üí∞`, 1000);
                });
            } catch (e) {
                console.error("Failed to collect coin:", e);
            }
        }


        // --- UI SCREENS ---

        /** Renders the Main Menu. */
        function MenuScreen() {
            return `
                <div class="flex flex-col items-center justify-center p-8 bg-white/90 rounded-3xl shadow-2xl backdrop-blur-sm">
                    <h1 class="text-4xl sm:text-6xl font-extrabold text-gray-800 mb-10 text-center tracking-tight">
                        Adventures of Bob the Stickman
                    </h1>
                    ${NavButton("‚ñ∂Ô∏è Play Game", "updateState({ currentView: 'game' })")}
                    ${NavButton("üõçÔ∏è Shop", "updateState({ currentView: 'shop' })", 'secondary')}
                    <p class="mt-6 text-sm text-gray-500">
                        Current User: <span class="font-mono text-gray-600 truncate max-w-xs block">${userId || 'Loading...'}</span>
                    </p>
                </div>
            `;
        }

        /** Renders a single upgrade item for the shop. */
        function UpgradeItem(upgrade) {
            const isOwned = ownedUpgrades[upgrade.key];
            const canAfford = coins >= upgrade.cost;
            let buttonText, buttonClass, action;

            if (isOwned) {
                buttonText = "Owned";
                buttonClass = "bg-gray-400 cursor-not-allowed";
                action = 'void(0)';
            } else if (canAfford) {
                buttonText = 'Buy (' + upgrade.cost + ' Coins)';
                buttonClass = "bg-primary-500 hover:bg-primary-600";
                action = `buyUpgrade('${upgrade.key}', ${upgrade.cost})`;
            } else {
                buttonText = 'Need ' + (upgrade.cost - coins) + ' More';
                buttonClass = "bg-red-500 opacity-70 cursor-not-allowed";
                action = 'void(0)';
            }

            return `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border-b border-gray-200 last:border-b-0">
                    <div class="flex items-start mb-2 sm:mb-0">
                        <span class="text-3xl mr-4">${upgrade.icon}</span>
                        <div>
                            <p class="font-bold text-gray-800">${upgrade.name}</p>
                            <p class="text-sm text-gray-500">${upgrade.description}</p>
                        </div>
                    </div>
                    <button onclick="${action}"
                        ${isOwned || !canAfford ? 'disabled' : ''}
                        class="px-4 py-2 text-sm font-semibold text-white rounded-lg transition duration-150 ${buttonClass}">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        /** Renders the Shop Screen. */
        function ShopScreen() {
            const upgradesList = UPGRADES.map(UpgradeItem).join('');

            return `
                <div class="flex flex-col items-center p-8 bg-white/90 rounded-3xl shadow-2xl backdrop-blur-sm w-full max-w-2xl">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">The Stickman Shop</h1>
                    <p class="text-3xl font-mono text-yellow-600 mb-6 font-extrabold">
                        üí∞ Coins: ${coins}
                    </p>

                    <h2 class="text-2xl font-extrabold text-gray-700 mt-4 mb-4 self-start border-b-2 border-primary-500 pb-1 w-full">
                        ‚¨ÜÔ∏è Upgrades
                    </h2>
                    <div class="w-full bg-gray-50 rounded-lg shadow-inner divide-y divide-gray-200">
                        ${upgradesList}
                    </div>

                    <h2 class="text-2xl font-extrabold text-gray-700 mt-8 mb-4 self-start border-b-2 border-primary-500 pb-1 w-full">
                        üé® Skins
                    </h2>
                    <div class="w-full bg-gray-50 rounded-lg shadow-inner p-4 text-center text-gray-500">
                        Skin selection feature coming soon! You currently have the default skin.
                    </div>

                    <button onclick="updateState({ currentView: 'menu' })"
                        class="mt-8 px-6 py-3 bg-secondary-500 hover:bg-secondary-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
                        ‚óÄÔ∏è Back to Menu
                    </button>
                </div>
            `;
        }

        /** Renders the Game Screen simulation. */
        function GameScreen() {
            const activeUpgrade = UPGRADES.find(u => u.key === activePowerUp);
            const activeUpgradeName = activeUpgrade ? activeUpgrade.name : 'None';
            const isPowerUpActive = activePowerUp !== null;
            const isPowerUpAvailable = Object.keys(ownedUpgrades).some(key => ownedUpgrades[key]);

            // Determine the appearance of Bob based on the active power-up
            let bobText = "Bob";
            let bobColor = '10b981'; // Green
            let bobStyle = '';
            
            if (activePowerUp === 'invisible') {
                bobText = "Invisible Bob";
                bobColor = 'f87171'; // Red
                bobStyle = 'opacity-50 ring-4 ring-red-500';
            } else if (activePowerUp === 'disappearObstacle') {
                bobText = "Bob: Smash!";
                bobColor = '3b82f6'; // Blue
                bobStyle = 'ring-4 ring-blue-500 animate-pulse';
            }

            const coinVisibility = isCoinAvailable ? 'block' : 'hidden';
            
            return `
                <div class="flex flex-col items-center p-8 bg-white/90 rounded-3xl shadow-2xl backdrop-blur-sm w-full max-w-lg">
                    <h1 class="text-4xl font-bold text-gray-800 mb-6">Game Running...</h1>
                    <p class="text-2xl font-mono text-yellow-600 mb-4 font-extrabold">
                        üí∞ Coins: ${coins}
                    </p>

                    <!-- Power-Up Status -->
                    <div class="p-4 rounded-lg w-full text-center mb-6 transition duration-500 border-4 ${
                        isPowerUpActive ? 'bg-red-200 border-red-500' : 'bg-gray-100 border-gray-300'
                    }">
                        <p class="text-sm font-semibold text-gray-700">
                            ${isPowerUpActive ? 'Power-Up Active!' : 'Active Power-Up:'}
                        </p>
                        <p class="text-xl font-bold text-red-700">${activeUpgradeName}</p>
                    </div>

                    <!-- Activation Prompt -->
                    <p class="text-xl font-bold p-3 rounded-lg border-2 mb-8 ${isPowerUpAvailable && !isPowerUpActive ? 'text-primary-700 bg-primary-100 border-primary-300' : 'text-gray-400 bg-gray-200 border-gray-300'}">
                        ${isPowerUpAvailable && !isPowerUpActive ? 
                            '<span>Press <kbd>B</kbd> to Activate Power-Up!</span>' : 
                            isPowerUpActive ? 
                            '<span>Power-Up is currently active!</span>' : 
                            '<span>Buy an upgrade in the shop to use this!</span>'
                        }
                    </p>

                    <!-- GAME SIMULATION AREA -->
                    <div class="w-full h-40 bg-gray-900 border-8 border-gray-600 rounded-lg relative overflow-hidden mb-8 shadow-inner game-simulation"
                         style="background-image: repeating-linear-gradient(90deg, #1f2937 0px, #1f2937 40px, #2a3541 40px, #2a3541 80px);">
                        <!-- Floor -->
                        <div class="absolute inset-x-0 bottom-0 h-4 bg-gray-500"></div>

                        <!-- Bob the Stickman - running/jumping area -->
                        <img
                            src="https://placehold.co/60x60/${bobColor}/ffffff?text=${bobText.replace(/ /g, '+')}"
                            alt="Bob the Stickman"
                            class="absolute left-4 bottom-0 transform -translate-y-1/2 rounded-full shadow-md transition-all duration-500 ${bobStyle}"
                            style="height: 60px; width: 60px; bottom: 1rem;"
                        />
                        
                        <!-- Collectible Coin - Click to simulate collection -->
                        <div 
                            onclick="handleCoinCollectionClick()"
                            class="absolute right-8 top-1/2 transform -translate-y-1/2 text-4xl cursor-pointer hover:scale-125 transition-transform duration-200 z-10 ${coinVisibility}"
                        >
                            üü°
                        </div>
                        
                        <!-- Obstacle Placeholder -->
                        <div class="absolute right-20 bottom-0 h-10 w-8 bg-red-600 rounded-sm" style="bottom: 1rem; animation: obstacle1 4s linear infinite;"></div>
                        <div class="absolute right-40 bottom-0 h-6 w-12 bg-red-800 rounded-sm" style="bottom: 1rem; animation: obstacle2 5s linear infinite;"></div>
                        
                        <style>
                            @keyframes obstacle1 { 0% { right: -10%; } 100% { right: 100%; } }
                            @keyframes obstacle2 { 0% { right: -20%; } 100% { right: 100%; } }
                        </style>
                    </div>

                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full justify-center">
                        <button onclick="updateState({ currentView: 'menu' })"
                            class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out w-full sm:w-auto">
                            ‚óÄÔ∏è Back to Menu
                        </button>
                    </div>
                </div>
            `;
        }


        // --- MAIN RENDER LOOP & EVENT LISTENERS ---

        /** The main rendering function, called after every state change. */
        function renderApp() {
            // Update internal state variables from window.gameData (to match React component structure)
            coins = window.gameData.coins;
            ownedUpgrades = window.gameData.ownedUpgrades;
            activePowerUp = window.gameData.activePowerUp;
            notification = window.gameData.notification;
            currentView = window.gameData.currentView;
            isCoinAvailable = window.gameData.isCoinAvailable;

            let html = '';
            switch (currentView) {
                case 'game':
                    html = GameScreen();
                    break;
                case 'shop':
                    html = ShopScreen();
                    break;
                case 'menu':
                default:
                    html = MenuScreen();
                    break;
            }
            appElement.innerHTML = html;

            // Re-render Notification separately to avoid content flash
            let notificationEl = document.getElementById('notification-area');
            if (!notificationEl) {
                notificationEl = document.createElement('div');
                notificationEl.id = 'notification-area';
                document.body.appendChild(notificationEl);
            }
            notificationEl.className = notification ? 
                'fixed top-4 left-1/2 -translate-x-1/2 p-3 bg-yellow-400 text-gray-800 font-bold rounded-lg shadow-xl z-50 transition-opacity duration-300' :
                'hidden';
            notificationEl.innerHTML = notification;
        }
        
        // Expose state update and coin collection for use in inline HTML handlers
        window.updateState = updateState;

        // Separate function for coin collection handling (needs to update local state immediately)
        window.handleCoinCollectionClick = () => {
            if (isCoinAvailable) {
                collectCoin(); // Calls Firestore transaction
                updateState({ isCoinAvailable: false });
                
                // Simulate the coin respawning after running a bit (2 seconds)
                setTimeout(() => {
                    updateState({ isCoinAvailable: true });
                }, 2000); 
            }
        };


        // Power Up Activation Key Listener
        window.addEventListener('keydown', (event) => {
            if (currentView === 'game' && event.key.toLowerCase() === 'b' && activePowerUp === null) {
                const availableUpgrade = UPGRADES.find(u => ownedUpgrades[u.key]);
                
                if (availableUpgrade) {
                    updateState({ activePowerUp: availableUpgrade.key });
                    showNotification(`${availableUpgrade.name} Activated! (5s)`);

                    // Set a timer for power-up duration
                    setTimeout(() => {
                        updateState({ activePowerUp: null });
                        showNotification('Power-up faded.', 1500);
                    }, POWER_UP_DURATION_MS);
                } else {
                    showNotification("No power-up owned or ready!", 1500);
                }
            }
        });


        // --- FIREBASE INITIALIZATION ---

        window.onload = function() {
            // Initialize global state container
            window.gameData = {
                coins: 0,
                ownedUpgrades: {},
                activePowerUp: null,
                notification: '',
                currentView: 'menu',
                isCoinAvailable: true
            };
            
            // Firebase setup
            setLogLevel('error');
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                renderApp(); // Render basic UI even if Firebase fails
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        let anonUser;
                        if (initialAuthToken) {
                            anonUser = await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            anonUser = await signInAnonymously(auth);
                        }
                        userId = anonUser.user.uid;
                    }
                    isAuthReady = true;

                    // Start Firestore Listener after Auth is ready
                    const userProfilePath = `/artifacts/${appId}/users/${userId}/gameData/profile`;
                    const docRef = doc(db, userProfilePath);

                    const unsubscribe = onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            updateState({
                                coins: data.coins || 0,
                                ownedUpgrades: data.upgrades || {},
                            });
                        } else {
                            setupUserData(docRef); // Create data if it doesn't exist
                        }
                    }, (error) => {
                        console.error("Firestore subscription error:", error);
                    });

                    // Initial render once auth is complete
                    renderApp(); 
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                renderApp();
            }
        };

    </script>
    <!-- End of HTML -->
</body>
</html>
